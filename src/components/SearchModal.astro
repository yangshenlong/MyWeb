---
/**
 * 搜索模态框组件
 * 使用 Pagefind 进行全文搜索
 */
---

<!-- 搜索触发按钮 -->
<button
	class="search-trigger"
	id="searchTrigger"
	aria-label="打开搜索"
	title="搜索文章 (Ctrl+K)"
>
	<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
		<circle cx="11" cy="11" r="8"></circle>
		<path d="M21 21l-4.35-4.35"></path>
	</svg>
	<span class="search-text">搜索</span>
	<kbd class="search-shortcut">⌘K</kbd>
</button>

<!-- 搜索模态框 -->
<div class="search-modal" id="searchModal" aria-hidden="true" role="dialog" aria-modal="true">
	<div class="search-backdrop" id="searchBackdrop"></div>

	<div class="search-container" role="document">
		<div class="search-header">
			<div class="search-input-wrapper">
				<svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
					<circle cx="11" cy="11" r="8"></circle>
					<path d="M21 21l-4.35-4.35"></path>
				</svg>
				<input
					type="text"
					id="searchInput"
					class="search-input"
					placeholder="搜索文章..."
					autocomplete="off"
					aria-label="搜索文章"
				/>
				<button class="search-clear" id="searchClear" aria-label="清除搜索" hidden>
					<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
						<line x1="18" y1="6" x2="6" y2="18"></line>
						<line x1="6" y1="6" x2="18" y2="18"></line>
					</svg>
				</button>
			</div>
			<div class="search-actions">
				<button class="search-close" id="searchClose" aria-label="关闭搜索">
					<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
						<line x1="18" y1="6" x2="6" y2="18"></line>
						<line x1="6" y1="6" x2="18" y2="18"></line>
					</svg>
				</button>
			</div>
		</div>

		<div class="search-body">
			<div class="search-status" id="searchStatus">
				<span class="status-text">输入关键词开始搜索...</span>
			</div>
			<div class="search-results" id="searchResults" role="listbox" aria-label="搜索结果">
				<!-- 搜索结果将动态插入这里 -->
			</div>
			<div class="search-empty" id="searchEmpty" hidden>
				<svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
					<circle cx="11" cy="11" r="8"></circle>
					<path d="M21 21l-4.35-4.35"></path>
				</svg>
				<p>未找到相关文章</p>
				<span>请尝试其他关键词</span>
			</div>
		</div>

		<div class="search-footer">
			<div class="search-hints">
				<span class="hint-item">
					<kbd>↑↓</kbd> 导航
				</span>
				<span class="hint-item">
					<kbd>↵</kbd> 打开
				</span>
				<span class="hint-item">
					<kbd>Esc</kbd> 关闭
				</span>
			</div>
		</div>
	</div>
</div>

<script>
	// Pagefind 搜索集成
	let pagefind: any = null;

	// 初始化 Pagefind - 使用脚本标签动态加载避免 Vite 静态分析错误
	async function initPagefind() {
		if (pagefind) return pagefind;

		// 检查是否已经加载
		if ((window as any).pagefind) {
			pagefind = (window as any).pagefind;
			return pagefind;
		}

		return new Promise((resolve) => {
			const script = document.createElement('script');
			script.src = '/pagefind/pagefind.js';
			script.async = true;

			script.onload = () => {
				pagefind = (window as any).pagefind;
				resolve(pagefind);
			};

			script.onerror = () => {
				console.warn('Pagefind 未初始化，搜索功能不可用（请先运行 npm run build 生成搜索索引）');
				resolve(null);
			};

			document.head.appendChild(script);
		});
	}

	// 搜索模态框管理
	const searchTrigger = document.getElementById('searchTrigger');
	const searchModal = document.getElementById('searchModal');
	const searchBackdrop = document.getElementById('searchBackdrop');
	const searchClose = document.getElementById('searchClose');
	const searchInput = document.getElementById('searchInput') as HTMLInputElement | null;
	const searchClear = document.getElementById('searchClear');
	const searchResults = document.getElementById('searchResults');
	const searchStatus = document.getElementById('searchStatus');
	const searchEmpty = document.getElementById('searchEmpty');

	let searchTimeout: ReturnType<typeof setTimeout>;
	let selectedIndex = -1;
	let currentResults: any[] = [];

	// 打开搜索
	function openSearch() {
		searchModal?.classList.add('open');
		searchModal?.setAttribute('aria-hidden', 'false');
		searchInput?.focus();
		document.body.style.overflow = 'hidden';

		// 初始化 Pagefind
		initPagefind();
	}

	// 关闭搜索
	function closeSearch() {
		searchModal?.classList.remove('open');
		searchModal?.setAttribute('aria-hidden', 'true');
		document.body.style.overflow = '';
		if (searchInput) {
			searchInput.value = '';
			searchClear?.setAttribute('hidden', '');
		}
		clearResults();
	}

	// 清除结果
	function clearResults() {
		if (searchResults) searchResults.innerHTML = '';
		if (searchStatus) searchStatus.querySelector('.status-text')!.textContent = '输入关键词开始搜索...';
		if (searchEmpty) searchEmpty.setAttribute('hidden', '');
		selectedIndex = -1;
		currentResults = [];
	}

	// 执行搜索
	async function performSearch(query: string) {
		if (!pagefind) {
			pagefind = await initPagefind();
		}

		if (!pagefind || !query.trim()) {
			clearResults();
			return;
		}

		// 更新状态
		if (searchStatus) {
			searchStatus.querySelector('.status-text')!.textContent = '搜索中...';
		}

		try {
			const results = await pagefind.search(query);
			currentResults = results.results;
			displayResults(results.results, query);
		} catch (error) {
			console.error('搜索失败:', error);
			if (searchStatus) {
				searchStatus.querySelector('.status-text')!.textContent = '搜索出错';
			}
		}
	}

	// 显示结果
	async function displayResults(results: any[], query: string) {
		if (!searchResults) return;

		searchResults.innerHTML = '';

		if (results.length === 0) {
			if (searchStatus) searchStatus.innerHTML = `<span class="status-text">找到 0 个结果</span>`;
			if (searchEmpty) searchEmpty.removeAttribute('hidden');
			return;
		}

		if (searchEmpty) searchEmpty.setAttribute('hidden', '');
		if (searchStatus) {
			searchStatus.innerHTML = `<span class="status-text">找到 ${results.length} 个结果</span>`;
		}

		// 显示前 10 个结果
		const displayCount = Math.min(results.length, 10);
		const fragment = document.createDocumentFragment();

		for (let i = 0; i < displayCount; i++) {
			const result = results[i];
			const data = await result.data();

			const item = document.createElement('div');
			item.className = 'search-result-item';
			item.setAttribute('role', 'option');
			item.setAttribute('data-index', String(i));
			item.tabIndex = -1;

			// 安全地创建链接元素，避免 XSS
			const link = document.createElement('a');
			link.href = data.url;
			link.className = 'search-result-link';

			const metaDiv = document.createElement('div');
			metaDiv.className = 'result-meta';

			const titleSpan = document.createElement('span');
			titleSpan.className = 'result-title';
			titleSpan.textContent = data.meta.title; // 使用 textContent 防止 XSS
			metaDiv.appendChild(titleSpan);

			link.appendChild(metaDiv);

			if (data.excerpt) {
				const excerptDiv = document.createElement('div');
				excerptDiv.className = 'result-excerpt';
				excerptDiv.textContent = data.excerpt; // 使用 textContent 防止 XSS
				link.appendChild(excerptDiv);
			}

			item.appendChild(link);

			item.addEventListener('click', () => {
				window.location.href = data.url;
			});

			fragment.appendChild(item);
		}

		searchResults.appendChild(fragment);

		// 添加键盘导航
		updateSelection();
	}

	// 更新选择
	function updateSelection() {
		const items = searchResults?.querySelectorAll('.search-result-item');
		if (!items) return;

		items.forEach((item, index) => {
			const el = item as HTMLElement;
			if (index === selectedIndex) {
				el.classList.add('selected');
				el.tabIndex = 0;
				el.focus();
			} else {
				el.classList.remove('selected');
				el.tabIndex = -1;
			}
		});
	}

	// 事件监听
	searchTrigger?.addEventListener('click', openSearch);
	searchBackdrop?.addEventListener('click', closeSearch);
	searchClose?.addEventListener('click', closeSearch);

	searchInput?.addEventListener('input', (e) => {
		const query = (e.target as HTMLInputElement).value;

		if (query.trim()) {
			searchClear?.removeAttribute('hidden');
		} else {
			searchClear?.setAttribute('hidden', '');
		}

		clearTimeout(searchTimeout);
		searchTimeout = setTimeout(() => {
			performSearch(query);
		}, 300);
	});

	searchClear?.addEventListener('click', () => {
		if (searchInput) searchInput.value = '';
		searchClear?.setAttribute('hidden', '');
		clearResults();
		searchInput?.focus();
	});

	// 键盘事件
	document.addEventListener('keydown', (e) => {
		// Cmd/Ctrl + K 打开搜索
		if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
			e.preventDefault();
			openSearch();
		}

		// Escape 关闭搜索
		if (e.key === 'Escape' && searchModal?.classList.contains('open')) {
			closeSearch();
		}

		// 导航结果
		if (searchModal?.classList.contains('open')) {
			if (e.key === 'ArrowDown') {
				e.preventDefault();
				selectedIndex = Math.min(selectedIndex + 1, currentResults.length - 1);
				updateSelection();
			} else if (e.key === 'ArrowUp') {
				e.preventDefault();
				selectedIndex = Math.max(selectedIndex - 1, -1);
				updateSelection();
			} else if (e.key === 'Enter' && selectedIndex >= 0) {
				e.preventDefault();
				const selectedItem = searchResults?.querySelector(`[data-index="${selectedIndex}"] a`);
				if (selectedItem) {
					(selectedItem as HTMLAnchorElement).click();
				}
			}
		}
	});
</script>

<style>
	/* 搜索触发按钮 */
	.search-trigger {
		display: flex;
		align-items: center;
		gap: 0.5em;
		padding: 0.5em 1em;
		background: rgba(255, 255, 255, var(--glass-opacity-bg-hover));
		border: 1px solid var(--border-standard);
		border-radius: 8px;
		color: var(--color-text-secondary);
		font-size: 0.85em;
		cursor: pointer;
		transition: all var(--transition-base);
	}

	.search-trigger:hover {
		background: rgba(99, 102, 241, 0.1);
		border-color: rgba(99, 102, 241, 0.3);
		color: var(--color-primary);
	}

	.search-text {
		font-size: 0.9em;
	}

	.search-shortcut {
		padding: 0.15em 0.4em;
		background: rgba(255, 255, 255, 0.05);
		border: 1px solid var(--border-subtle);
		border-radius: 4px;
		font-size: 0.75em;
		font-family: 'Space Mono', monospace;
		color: var(--color-text-muted);
	}

	/* 搜索模态框 */
	.search-modal {
		position: fixed;
		top: 0;
		left: 0;
		right: 0;
		bottom: 0;
		z-index: 2000;
		display: flex;
		align-items: flex-start;
		justify-content: center;
		padding-top: 15vh;
		opacity: 0;
		visibility: hidden;
		transition: all var(--transition-base);
	}

	.search-modal.open {
		opacity: 1;
		visibility: visible;
	}

	.search-backdrop {
		position: absolute;
		top: 0;
		left: 0;
		right: 0;
		bottom: 0;
		background: rgba(0, 0, 0, 0.6);
		backdrop-filter: blur(4px);
	}

	.search-container {
		position: relative;
		width: 90%;
		max-width: 640px;
		max-height: 70vh;
		background: var(--color-bg-secondary);
		border: 1px solid var(--border-standard);
		border-radius: 16px;
		box-shadow: var(--shadow-lg);
		display: flex;
		flex-direction: column;
		overflow: hidden;
		transform: translateY(-20px) scale(0.95);
		transition: transform var(--transition-base);
	}

	.search-modal.open .search-container {
		transform: translateY(0) scale(1);
	}

	/* 搜索头部 */
	.search-header {
		display: flex;
		align-items: center;
		gap: 1em;
		padding: 1.25em;
		border-bottom: 1px solid var(--border-standard);
	}

	.search-input-wrapper {
		position: relative;
		flex: 1;
		display: flex;
		align-items: center;
		gap: 0.75em;
		padding: 0.75em 1em;
		background: var(--color-bg-tertiary);
		border: 1px solid var(--border-standard);
		border-radius: 10px;
		transition: all var(--transition-base);
	}

	.search-input-wrapper:focus-within {
		border-color: var(--color-primary);
		box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
	}

	.search-icon {
		flex-shrink: 0;
		color: var(--color-text-muted);
	}

	.search-input {
		flex: 1;
		background: transparent;
		border: none;
		outline: none;
		color: var(--color-text-primary);
		font-size: 1em;
		font-family: var(--font-sans);
	}

	.search-input::placeholder {
		color: var(--color-text-muted);
	}

	.search-clear {
		flex-shrink: 0;
		padding: 0.25em;
		background: transparent;
		border: none;
		color: var(--color-text-muted);
		cursor: pointer;
		border-radius: 4px;
		transition: all var(--transition-fast);
	}

	.search-clear:hover {
		color: var(--color-text-secondary);
		background: rgba(255, 255, 255, 0.05);
	}

	.search-close {
		flex-shrink: 0;
		padding: 0.5em;
		background: transparent;
		border: none;
		color: var(--color-text-muted);
		cursor: pointer;
		border-radius: 8px;
		transition: all var(--transition-fast);
	}

	.search-close:hover {
		color: var(--color-text-primary);
		background: rgba(255, 255, 255, 0.05);
	}

	/* 搜索主体 */
	.search-body {
		flex: 1;
		overflow-y: auto;
		padding: 0;
	}

	.search-status {
		padding: 1em 1.25em;
		border-bottom: 1px solid var(--border-subtle);
	}

	.status-text {
		font-size: 0.85em;
		color: var(--color-text-muted);
		font-family: 'Space Mono', monospace;
	}

	.search-results {
		padding: 0.5em;
	}

	.search-result-item {
		margin-bottom: 0.25em;
		border-radius: 8px;
		transition: all var(--transition-fast);
	}

	.search-result-item.selected,
	.search-result-item:hover {
		background: rgba(99, 102, 241, 0.1);
	}

	.search-result-link {
		display: block;
		padding: 1em;
		text-decoration: none;
		color: inherit;
	}

	.result-meta {
		margin-bottom: 0.5em;
	}

	.result-title {
		font-size: 1em;
		font-weight: 500;
		color: var(--color-text-primary);
		display: block;
	}

	.result-excerpt {
		font-size: 0.9em;
		color: var(--color-text-tertiary);
		line-height: 1.6;
		overflow: hidden;
		text-overflow: ellipsis;
		display: -webkit-box;
		-webkit-line-clamp: 2;
		-webkit-box-orient: vertical;
	}

	.result-excerpt mark {
		background: rgba(99, 102, 241, 0.3);
		color: inherit;
		padding: 0 0.2em;
		border-radius: 2px;
	}

	/* 空状态 */
	.search-empty {
		display: flex;
		flex-direction: column;
		align-items: center;
		justify-content: center;
		padding: 4em 2em;
		text-align: center;
	}

	.search-empty svg {
		color: var(--color-text-muted);
		margin-bottom: 1.5em;
		opacity: 0.5;
	}

	.search-empty p {
		font-size: 1.1em;
		color: var(--color-text-secondary);
		margin: 0 0 0.5em 0;
	}

	.search-empty span {
		font-size: 0.9em;
		color: var(--color-text-muted);
	}

	/* 搜索底部 */
	.search-footer {
		padding: 0.75em 1.25em;
		border-top: 1px solid var(--border-standard);
		background: var(--color-bg-tertiary);
	}

	.search-hints {
		display: flex;
		gap: 1.5em;
		justify-content: center;
	}

	.hint-item {
		display: flex;
		align-items: center;
		gap: 0.5em;
		font-size: 0.75em;
		color: var(--color-text-muted);
	}

	.hint-item kbd {
		padding: 0.15em 0.4em;
		background: rgba(255, 255, 255, 0.05);
		border: 1px solid var(--border-subtle);
		border-radius: 4px;
		font-family: 'Space Mono', monospace;
	}

	/* 滚动条 */
	.search-body::-webkit-scrollbar {
		width: 6px;
	}

	.search-body::-webkit-scrollbar-track {
		background: transparent;
	}

	.search-body::-webkit-scrollbar-thumb {
		background: var(--border-hover);
		border-radius: 3px;
	}

	/* 响应式 */
	@media (max-width: 768px) {
		.search-modal {
			padding-top: 0;
			align-items: flex-end;
		}

		.search-container {
			width: 100%;
			max-width: 100%;
			max-height: 80vh;
			border-radius: 16px 16px 0 0;
			transform: translateY(100%);
		}

		.search-modal.open .search-container {
			transform: translateY(0);
		}

		.search-shortcut {
			display: none;
		}

		.search-hints {
			flex-wrap: wrap;
			gap: 1em;
		}
	}

	/* 无障碍 */
	@media (prefers-reduced-motion: reduce) {
		.search-modal,
		.search-container,
		.search-result-item {
			transition: none;
		}
	}
</style>

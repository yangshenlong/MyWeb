---
import HeaderArchitectural from '../components/HeaderArchitectural.astro';
import GlassCard from '../components/GlassCard.astro';
import BlogActivityHeatmap from '../components/BlogActivityHeatmap.astro';
import BackToTop from '../components/BackToTop.astro';
import ScrollProgress from '../components/ScrollProgress.astro';
import Footer from '../components/Footer.astro';
import { SITE_TITLE, SITE_DESCRIPTION } from '../consts';
import { getCollection } from 'astro:content';

// è·å–æ‰€æœ‰åšå®¢æ–‡ç« 
const allPosts = await getCollection('blog');

// æŒ‰æ—¥æœŸæ’åº
const sortedPosts = allPosts.sort((a, b) =>
	Math.floor(new Date(b.data.pubDate).getTime() / 1000) -
	Math.floor(new Date(a.data.pubDate).getTime() / 1000)
);

// æå–æ‰€æœ‰å”¯ä¸€æ ‡ç­¾
const allTags = new Set<string>();
allPosts.forEach(post => {
	(post.data.tags || []).forEach(tag => allTags.add(tag));
});

const sortedTags = Array.from(allTags).sort();
---

<!doctype html>
<html lang="zh-CN">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>åšå®¢ | {SITE_TITLE}</title>
		<meta name="description" content={SITE_DESCRIPTION} />
		<link rel="preconnect" href="https://fonts.googleapis.com" />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
		<link href="https://fonts.googleapis.com/css2?family=Inter:wght@200;300;400;500;600&family=Space+Mono:wght@400;500&display=swap" rel="stylesheet" />

		<style is:global>
			* {
				margin: 0;
				padding: 0;
				box-sizing: border-box;
			}

			body {
				font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
				background: #050505;
				color: rgba(255, 255, 255, 0.9);
				line-height: 1.6;
			}

			a {
				color: inherit;
				text-decoration: none;
			}
		</style>
	</head>

	<body>
		<ScrollProgress />
		<HeaderArchitectural />

		<!-- Page Header -->
		<section class="page-header">
			<div class="header-content">
				<div class="breadcrumb">
					<span class="breadcrumb-item">
						<a href="/">é¦–é¡µ</a>
					</span>
					<span class="breadcrumb-separator">/</span>
					<span class="breadcrumb-item current">åšå®¢</span>
				</div>
				<h1 class="page-title">æŠ€æœ¯æ–‡ç« </h1>
				<p class="page-subtitle">Technical Articles</p>
			</div>
			<div class="header-decoration">
				<span class="deco-number">03</span>
			</div>
		</section>

			<!-- Blog Grid -->
		<section class="blog-section">
			<div class="blog-container">
				<!-- æœç´¢å’Œè¿‡æ»¤ -->
				<aside class="sidebar">
					{/* è´¡çŒ®çƒ­åŠ›å›¾ */}
					<GlassCard class="activity-card">
						<div class="card-header">
							<h3>Activity</h3>
						</div>
						<BlogActivityHeatmap
							collection="blog"
							weeks={52}
							showStats={true}
							includeUpdates={true}
							theme="dark"
						/>
					</GlassCard>

					<GlassCard class="search-card">
						<div class="search-header">
							<h3>æœç´¢æ–‡ç« </h3>
						</div>
						<div class="search-box">
							<input
								type="text"
								id="postSearch"
								class="search-input"
								placeholder="æœç´¢æ ‡é¢˜æˆ–å†…å®¹..."
							/>
							<span class="search-icon">ğŸ”</span>
						</div>
					</GlassCard>

					<!-- æ ‡ç­¾è¿‡æ»¤å™¨ -->
					{sortedTags.length > 0 && (
						<GlassCard class="tags-filter-card">
							<div class="filter-header">
								<h3>æ ‡ç­¾è¿‡æ»¤</h3>
								<a href="/tags" class="view-all-tags">æŸ¥çœ‹å…¨éƒ¨ â†’</a>
							</div>
							<div class="tags-filter">
								<button
									class="filter-all active"
									data-filter="all"
								>
									å…¨éƒ¨æ–‡ç« 
								</button>
								{sortedTags.map(tag => (
									<button
										class={`filter-tag ${tag === 'all' ? 'active' : ''}`}
										data-filter={tag}
									>
										{tag}
									</button>
								))}
							</div>
						</GlassCard>
					)}
				</aside>

				<!-- æ–‡ç« åˆ—è¡¨ -->
				<div class="posts-wrapper">
					<div class="posts-count">
						<span id="postsCount">{sortedPosts.length}</span> ç¯‡æ–‡ç« 
					</div>
					{sortedPosts.length > 0 ? (
						<div class="posts-grid">
							{sortedPosts.map((post, index) => {
								const postTags = post.data.tags || [];
								const slug = post.id.replace(/\.(md|mdx)$/, '');
								const postUrl = `/blog/${slug}`;
								return (
									<article
										class="post-item"
										style={`--delay: ${index * 100}ms`}
										data-tags={postTags.join(',')}
										data-title={post.data.title.toLowerCase()}
										data-description={(post.data.description || '').toLowerCase()}
									>
										<a href={postUrl} class="post-link">
											<GlassCard class="post-card">
												<div class="post-meta">
													<time class="post-date">
														{new Date(post.data.pubDate).toLocaleDateString('zh-CN', {
															year: 'numeric',
															month: '2-digit',
															day: '2-digit'
														})}
													</time>
													{post.data.category && (
														<span class="post-category">{post.data.category}</span>
													)}
												</div>
												<h2 class="post-title">{post.data.title}</h2>
												{post.data.description && (
													<p class="post-description">{post.data.description}</p>
												)}
												{postTags.length > 0 && (
													<div class="post-tags">
														{postTags.map((tag: string) => (
															<span class="tag">{tag}</span>
														))}
													</div>
												)}
											</GlassCard>
										</a>
									</article>
								);
							})}
						</div>
					) : (
						<div class="empty-state">
							<div class="empty-message">
								<h3>æš‚æ— æ–‡ç« </h3>
								<p>æ•¬è¯·æœŸå¾…æ›´å¤šæŠ€æœ¯åˆ†äº«</p>
							</div>
						</div>
					)}
				</div>
			</div>
		</section>

		<!-- Footer -->
		<Footer />

		<BackToTop />

		<script>
			// æœç´¢åŠŸèƒ½
			const searchInput = document.getElementById('postSearch') as HTMLInputElement;
			const filterButtons = document.querySelectorAll('.filter-all, .filter-tag');
			const postItems = document.querySelectorAll('.post-item');
			const postsCount = document.getElementById('postsCount') as HTMLElement;
			let currentFilter = 'all';

			// è¿‡æ»¤æŒ‰é’®ç‚¹å‡»äº‹ä»¶
			filterButtons.forEach(btn => {
				btn.addEventListener('click', () => {
					// æ›´æ–°æŒ‰é’®çŠ¶æ€
					filterButtons.forEach(b => b.classList.remove('active'));
					btn.classList.add('active');

					// è·å–è¿‡æ»¤æ ‡ç­¾
					currentFilter = (btn as HTMLElement).dataset.filter || 'all';

					// è¿‡æ»¤æ–‡ç« 
					filterPosts();
				});
			});

			// æœç´¢è¾“å…¥äº‹ä»¶
			searchInput?.addEventListener('input', () => {
				filterPosts();
			});

			// è¿‡æ»¤æ–‡ç« å‡½æ•°
			function filterPosts() {
				const searchTerm = (searchInput?.value || '').toLowerCase().trim();
				let visibleCount = 0;

				postItems.forEach(post => {
					const postEl = post as HTMLElement;
					const tags = postEl.dataset.tags || '';
					const title = postEl.dataset.title || '';
					const description = postEl.dataset.description || '';

					// æ£€æŸ¥æœç´¢è¯
					const matchesSearch = searchTerm === '' ||
						title.includes(searchTerm) ||
						description.includes(searchTerm);

					// æ£€æŸ¥æ ‡ç­¾è¿‡æ»¤
					const matchesFilter = currentFilter === 'all' || tags.includes(currentFilter);

					// æ˜¾ç¤ºæˆ–éšè—
					if (matchesSearch && matchesFilter) {
						postEl.style.display = '';
						visibleCount++;
					} else {
						postEl.style.display = 'none';
					}
				});

				// æ›´æ–°æ–‡ç« æ•°é‡
				if (postsCount) {
					postsCount.textContent = visibleCount.toString();
				}
			}
		</script>

		<style>
			.page-header {
				padding: calc(60px + var(--section-padding-y, 8em)) 4em 6em;
				background: #050505;
				position: relative;
				display: flex;
				align-items: center;
				justify-content: space-between;
				max-width: 1600px;
				margin: 0 auto;
			}

			.header-content {
				flex: 1;
			}

			.breadcrumb {
				display: flex;
				align-items: center;
				gap: 0.75em;
				margin-bottom: 1.5em;
			}

			.breadcrumb-item {
				font-size: 0.75em;
				letter-spacing: 0.2em;
				text-transform: uppercase;
				color: rgba(255, 255, 255, 0.4);
				transition: color 0.3s ease;
			}

			.breadcrumb-item:hover {
				color: rgba(255, 255, 255, 0.7);
			}

			.breadcrumb-item.current {
				color: rgba(255, 255, 255, 0.7);
			}

			.breadcrumb-separator {
				color: rgba(255, 255, 255, 0.2);
			}

			.page-title {
				font-size: clamp(3em, 8vw, 6em);
				font-weight: 200;
				letter-spacing: -0.03em;
				line-height: 1;
				margin: 0 0 0.5em 0;
			}

			.page-subtitle {
				font-size: 1em;
				letter-spacing: 0.2em;
				text-transform: uppercase;
				color: rgba(255, 255, 255, 0.4);
				margin: 0;
			}

			.header-decoration {
				position: relative;
			}

			.deco-number {
				font-size: 8em;
				font-weight: 100;
				color: rgba(255, 255, 255, 0.03);
				font-family: 'Space Mono', monospace;
				line-height: 1;
			}

			/* Blog Section */
			.blog-section {
				padding: 6em 4em;
				background: #050505;
			}

			.blog-container {
				max-width: 1400px;
				margin: 0 auto;
				display: grid;
				grid-template-columns: 280px 1fr;
				gap: 3em;
				align-items: start;
			}

			/* Sidebar */
			.sidebar {
				display: flex;
				flex-direction: column;
				gap: var(--grid-gap, 2em);
				position: sticky;
				top: 2em;
			}

			/* Activity Card */
			.activity-card {
				padding: 1.5em;
			}

			.activity-card .card-header h3 {
				font-size: 1em;
				font-weight: 400;
				color: rgba(255, 255, 255, 0.95);
				margin: 0 0 1em 0;
			}

			/* Search Card */
			.search-card {
				padding: 1.5em;
			}

			.search-header h3 {
				font-size: 1em;
				font-weight: 400;
				color: rgba(255, 255, 255, 0.95);
				margin: 0 0 1em 0;
			}

			.search-box {
				position: relative;
			}

			.search-input {
				width: 100%;
				padding: 0.75em 1em 0.75em 2.5em;
				background: rgba(255, 255, 255, 0.05);
				border: 1px solid rgba(255, 255, 255, 0.08);
				border-radius: 4px;
				color: rgba(255, 255, 255, 0.9);
				font-size: 0.9em;
				font-family: 'Inter', sans-serif;
				transition: all 0.3s ease;
			}

			.search-input::placeholder {
				color: rgba(255, 255, 255, 0.4);
			}

			.search-input:focus {
				outline: none;
				border-color: rgba(255, 255, 255, 0.2);
				background: rgba(255, 255, 255, 0.08);
			}

			.search-icon {
				position: absolute;
				left: 0.75em;
				top: 50%;
				transform: translateY(-50%);
				font-size: 0.9em;
				opacity: 0.5;
			}

			/* Posts Count */
			.posts-count {
				font-size: 0.85em;
				color: rgba(255, 255, 255, 0.5);
				margin-bottom: 1.5em;
			}

			.posts-count span {
				font-family: 'Space Mono', monospace;
				font-size: 1.2em;
				color: rgba(255, 255, 255, 0.8);
			}

			/* Tags Sidebar */
			.tags-sidebar {
				position: sticky;
				top: 2em;
			}

			.tags-filter-card {
				padding: 1.5em;
			}

			.filter-header {
				display: flex;
				justify-content: space-between;
				align-items: center;
				margin-bottom: 1.5em;
				padding-bottom: 1em;
				border-bottom: 1px solid rgba(255, 255, 255, 0.06);
			}

			.filter-header h3 {
				font-size: 1em;
				font-weight: 400;
				color: rgba(255, 255, 255, 0.95);
				margin: 0;
			}

			.view-all-tags {
				font-size: 0.75em;
				color: rgba(255, 255, 255, 0.5);
				transition: color 0.3s ease;
			}

			.view-all-tags:hover {
				color: rgba(255, 255, 255, 0.8);
			}

			.tags-filter {
				display: flex;
				flex-direction: column;
				gap: 0.5em;
			}

			.filter-all,
			.filter-tag {
				text-align: left;
				padding: 0.6em 1em;
				background: transparent;
				border: 1px solid rgba(255, 255, 255, 0.08);
				color: rgba(255, 255, 255, 0.6);
				font-size: 0.85em;
				font-family: 'Inter', sans-serif;
				cursor: pointer;
				transition: all 0.3s ease;
				border-radius: 4px;
			}

			.filter-all:hover,
			.filter-tag:hover {
				background: rgba(255, 255, 255, 0.05);
				border-color: rgba(255, 255, 255, 0.12);
				color: rgba(255, 255, 255, 0.8);
			}

			.filter-all.active,
			.filter-tag.active {
				background: rgba(255, 255, 255, 0.1);
				border-color: rgba(255, 255, 255, 0.2);
				color: rgba(255, 255, 255, 0.95);
			}

			/* Posts Wrapper */
			.posts-wrapper {
				min-width: 0;
			}

			.posts-grid {
				display: grid;
				grid-template-columns: 1fr;
				gap: 1.5em;
				max-width: 800px;
				margin: 0 auto;
			}

			.post-item {
				animation: fadeInUp 0.6s ease-out backwards;
				animation-delay: var(--delay);
			}

			@keyframes fadeInUp {
				from {
					opacity: 0;
					transform: translateY(30px);
				}
				to {
					opacity: 1;
					transform: translateY(0);
				}
			}

			.post-link {
				display: block;
				cursor: pointer;
			}

			.post-link:hover {
				cursor: pointer;
			}

			/* ç¡®ä¿å†…å®¹åœ¨é¡¶å±‚ */
			.post-card :global(.card-content) {
				z-index: 10;
			}

			.post-card {
				height: 100%;
				transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
			}

			.post-card::after {
				content: '';
				position: absolute;
				bottom: 0;
				left: 2em;
				right: 2em;
				height: 1px;
				background: linear-gradient(
					90deg,
					transparent 0%,
					rgba(255, 255, 255, 0.1) 50%,
					transparent 100%
				);
				transform: scaleX(0);
				transition: transform 0.4s ease;
				z-index: 5;
				pointer-events: none;
			}

			.post-card:hover::after {
				transform: scaleX(1);
			}

			.post-card:hover {
				transform: translateY(-12px);
			}

			.post-meta {
				display: flex;
				justify-content: space-between;
				align-items: center;
				margin-bottom: 2em;
				padding-bottom: 1.5em;
				border-bottom: 1px solid rgba(255, 255, 255, 0.06);
			}

			.post-date {
				font-size: 0.75em;
				color: rgba(255, 255, 255, 0.5);
				font-family: 'Space Mono', monospace;
				letter-spacing: 0.1em;
			}

			.post-category {
				font-size: 0.7em;
				letter-spacing: 0.15em;
				text-transform: uppercase;
				color: rgba(255, 255, 255, 0.4);
				padding: 0.3em 0.8em;
				background: rgba(255, 255, 255, 0.05);
				border: 1px solid rgba(255, 255, 255, 0.08);
			}

			.post-title {
				font-size: 1.5em;
				font-weight: 300;
				letter-spacing: -0.02em;
				color: rgba(255, 255, 255, 0.95);
				margin: 0 0 1em 0;
				line-height: 1.4;
			}

			.post-description {
				font-size: 0.95em;
				line-height: 1.7;
				color: rgba(255, 255, 255, 0.6);
				margin: 0 0 1.5em 0;
			}

			.post-tags {
				display: flex;
				flex-wrap: wrap;
				gap: 0.5em;
			}

			.tag {
				font-size: 0.7em;
				letter-spacing: 0.1em;
				padding: 0.3em 0.8em;
				background: rgba(255, 255, 255, 0.05);
				border: 1px solid rgba(255, 255, 255, 0.08);
				color: rgba(255, 255, 255, 0.5);
			}

			/* Empty State */
			.empty-state {
				text-align: center;
				padding: 8em 0;
			}

			.empty-message h3 {
				font-size: 2em;
				font-weight: 300;
				color: rgba(255, 255, 255, 0.7);
				margin-bottom: 1em;
			}

			.empty-message p {
				font-size: 1em;
				color: rgba(255, 255, 255, 0.5);
			}

			/* Footer styles moved to Footer.astro component */


			.footer-content {
				display: flex;
				justify-content: space-between;
				align-items: center;
			}

			.footer-left {
				display: flex;
				align-items: center;
				gap: 1em;
			}

			.footer-text {
				font-size: 0.85em;
				color: rgba(255, 255, 255, 0.4);
			}

			.footer-divider {
				color: rgba(255, 255, 255, 0.2);
			}

			.footer-right {
				display: flex;
				gap: 2em;
			}

			.footer-link {
				font-size: 0.85em;
				color: rgba(255, 255, 255, 0.5);
				transition: color 0.3s ease;
			}

			/* Responsive */
			@media (max-width: 1024px) {
				.page-header,
				.blog-section {
					padding-left: 2em;
					padding-right: 2em;
				}

				.page-header {
					flex-direction: column;
					gap: 2em;
				}

				.header-decoration {
					align-self: flex-end;
				}

				.deco-number {
					font-size: 4em;
				}

				.blog-container {
					grid-template-columns: 1fr;
				}

				.sidebar {
					position: static;
					flex-direction: row;
					flex-wrap: wrap;
				}

				.search-card,
				.tags-filter-card {
					flex: 1;
					min-width: 250px;
				}

				.tags-filter {
					flex-direction: row;
					flex-wrap: wrap;
				}

				.filter-all,
				.filter-tag {
					flex: 0 0 auto;
				}

				.posts-grid {
					grid-template-columns: 1fr;
				}
			}

			@media (max-width: 768px) {
				.footer-content {
					flex-direction: column;
					gap: 1.5em;
					text-align: center;
				}

				.footer-left {
					flex-direction: column;
					gap: 0.5em;
				}

				.footer-right {
					gap: 1.5em;
				}

				.sidebar {
					flex-direction: column;
				}

				.search-card,
				.tags-filter-card {
					min-width: 100%;
				}
			}
		</style>
	</body>
</html>
